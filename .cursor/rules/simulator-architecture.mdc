---
name: simulator-architecture
description: This rule describes the architecture of the KIPR Simulator.
alwaysApply: false
---

# Simulator Architecture

## Tech stack

- Language/runtime: TypeScript and JavaScript on Node.js (server) and the browser (client).
- Frontend: React 18 + React Router + Redux, with Styletron for CSS-in-JS styling.
- 3D/physics: BabylonJS with Havok physics.
- Backend: Express server with session + CSRF handling, proxy to the KIPR database API, and metrics via prom-client.
- Programming runtime: Web workers execute user code; languages include C/C++, Python (Emscripten/CPython artifacts), and graphical (Scratch/itch runtime).
- Build: Webpack 5 + Babel + ts-loader, html-webpack-plugin for multiple entrypoints.
- Tooling: ESLint (flat config + @typescript-eslint), Jest (ts-jest), i18n via gettext PO files.

## Architecture overview

- Server (`express.js`) boots with configuration from `config.js` and `dependencies/dependencies.json`.
  - Serves compiled frontend assets from `dist/` and static files from `static/`.
  - Hosts Scratch assets from `node_modules/kipr-scratch` and optional runtime artifacts (cpython, libkipr).
  - Proxies `/api` requests to the configured database service and exposes `/api/parental-consent` and `/api/ai` routers.
  - Provides `/compile` for C compilation when Emscripten/libkipr artifacts are present.
  - Exposes `/metrics` for Prometheus-style metrics and posts feedback via a Discord webhook.

- Frontend entrypoints are defined in Webpack (`configs/webpack/common.js`).
  - Main app entry is `src/index.tsx` which sets up Styletron, Redux, and React Router.
  - Additional standalone entrypoints for login, LMS plugin, and parental consent screens.

- State and data flow.
  - Global state lives in Redux (`src/state`) with model types in `src/state/State` and reducers in `src/state/reducer`.
  - Data access helpers in `src/db` provide selectors and typed records for database entities.
  - Firebase auth is configured in `src/firebase` and used by the app router/consent logic.

- Simulator runtime.
  - `src/simulator/Space.ts` creates and runs the Babylon scene and physics loop.
  - `src/simulator/babylonBindings` bridges Redux scene/robot state to Babylon nodes and materials.
  - `src/simulator/definitions` contains canonical definitions for scenes, challenges, nodes, and robots.
  - `src/simulator/ScriptManager` orchestrates simulation events and scripts.

- Programming execution.
  - `src/programming/worker` hosts the web worker runtime.
  - `src/programming/compiler` sends compile requests to `/compile` for C/C++.
  - `src/programming/python` loads Python artifacts when available and wires registers/devices.
  - `src/programming/registers` and `src/programming/buffers` provide shared memory and IO surfaces.

## File structure

Top level:
- `src/`: Application source (React UI, simulator, programming runtime, state, utilities).
- `configs/`: Webpack build configuration for dev/prod.
- `static/`: 3D models, textures, images, and other static assets.
- `dist/`: Build output (generated by Webpack).
- `dependencies/`: Submodules and build artifacts (libwallaby, emsdk, cpython, kipr-scratch).
- `i18n/`: gettext PO files and translation build tooling.
- `test/`: Jest tests.
- `ai/`: AI prompt material and server support.
- `grafana-dashboards/`: Monitoring dashboards for metrics/logs.

Key `src/` areas:
- `src/App.tsx`: Top-level routing and auth/consent gating.
- `src/components/`: Reusable UI components.
- `src/pages/`: Route-level page components.
- `src/simulator/`: Simulation engine, Babylon bindings, definitions, and scripts.
- `src/programming/`: Code execution pipeline (workers, compiler, Python integration).
- `src/state/`: Redux store setup and reducers; `src/state/State` holds model types.
- `src/db/`: Data access layer and selectors for remote API records.
- `src/firebase/`: Firebase initialization and auth helpers.
- `src/util/`: Shared utilities (math, i18n helpers, redux patching, etc.).
- `src/types/`: TypeScript declaration files for assets and globals.

## Codebase standards

- Linting and style (from `eslint.config.mjs`):
  - 2-space indentation, 1tbs brace style, semicolons required.
  - Prefer `const`, template literals, and arrow callbacks.
  - Consistent spacing rules (object/array spacing, keyword spacing, space-infix-ops).
  - TypeScript linting uses `@typescript-eslint` with type-aware rules enabled.

- TypeScript configuration (`tsconfig.json`):
  - `baseUrl` is `src` with path aliases `@i18n` and `state/*`.
  - ES2020 modules, ES6 target, React JSX.
  - BabylonJS typings are included globally.

- Internationalization (README + `i18n/`):
  - Strings are gathered from `@i18n` usage and built into `i18n/i18n.json`.
  - Use `yarn run generate-i18n` to update PO files and `yarn run build-i18n` to produce JSON.
    - Be aware that `yarn run generate-i18n` may overwrite existing work in PO files.

- Testing: Jest is configured in `jest.config.js` and runs tests from `test/`.
  - `ts-jest` handles TypeScript with BabylonJS transpiled as needed.

- Build and assets:
  - Webpack outputs to `dist/` and injects build-time constants like version and i18n JSON.
  - Asset loaders handle images/fonts; static files live under `static/`.

